# Smart Photo Diary アーキテクチャ概要

## 目的
写真を選ぶだけでAIが自動的に日記を生成するモバイルアプリ。すべてのデータは端末ローカルに安全に保存され、プライバシーファーストの設計となっている。

## 全体アーキテクチャ

### サービス層パターン
アプリは以下のサービス層で構成され、依存性注入による疎結合設計を採用：

- **DiaryService**: 中央データ管理、Hiveデータベース操作
- **PhotoService**: 写真アクセスと権限管理（photo_manager）
- **AiService**: AI日記生成（Google Gemini API + オフラインフォールバック）
- **SettingsService**: アプリ設定管理（SharedPreferences）
- **StorageService**: ファイルシステム操作、データエクスポート
- **LoggingService**: 構造化ログとパフォーマンス監視

### エラーハンドリング
- **Result<T>パターン**: 関数型エラーハンドリング
- **統一例外階層**: AppException基底クラス
- **統一エラー表示**: ErrorDisplayService

### 依存性注入
- **ServiceLocator**: 中央DIコンテナ
- **インターフェース設計**: テスタビリティ向上
- **遅延初期化**: パフォーマンス最適化

## データフロー

### 日記生成フロー
1. ユーザーが写真を選択（PhotoService）
2. 写真がAI推論に送信（AiService）
3. Gemini APIで日記生成（オンライン） / フォールバック機能（オフライン）
4. 生成された日記をローカルDB保存（DiaryService）
5. UI更新と統計情報更新

### AI処理アーキテクチャ
- **日記生成**: Google Gemini 2.5 Flash API（オンライン）
- **オフラインフォールバック**: テンプレートベース日記生成
- **タグ生成**: Gemini API（オンライン） / 基本タグ（オフライン）

## データ永続化

### Hive NoSQLデータベース
- 日記エントリー（DiaryEntry）
- アプリ設定
- タグ情報
- 統計データ

### ファイルシステム
- 写真ファイル参照
- エクスポートデータ（JSON）

## UI/UX アーキテクチャ

### デザインシステム
- **Material Design 3**: 統一されたデザイン言語
- **テーマシステム**: ライト/ダーク/システム連動
- **カラーシステム**: 動的色彩とアクセントカラー
- **タイポグラフィ**: 日本語フォント最適化

### 画面構成
- **ホーム画面**: 写真選択とクイックアクセス
- **日記一覧**: フィルター・検索機能
- **統計画面**: カレンダーと分析表示
- **設定画面**: テーマ・データ管理

### 状態管理
- **コントローラーパターン**: ChangeNotifier使用
- **リアクティブUI**: FutureBuilder/StreamBuilder
- **ローカル状態**: StatefulWidget

## セキュリティ・プライバシー

### データローカライゼーション
- 全データは端末内保存
- クラウド同期なし
- API通信は日記生成時のみ

### 権限管理
- 写真アクセス権限（permission_handler）
- ファイルシステムアクセス
- ネットワーク接続（オプション）

## パフォーマンス最適化

### 画像処理
- デバイスピクセル比対応
- 効率的なキャッシュ戦略
- RepaintBoundary最適化


## テストアーキテクチャ

### 3層テスト戦略
1. **Unit Tests**: モックによる純粋ロジックテスト
2. **Widget Tests**: UI コンポーネントテスト
3. **Integration Tests**: E2E フローテスト

### テスト支援
- mocktail による統一モック
- 依存性注入による分離
- プラットフォームチャンネルモック

## 開発品質

### コード品質
- Flutter analyze: 0 issues
- 100%テスト成功率（133テスト）
- 一貫したコーディング標準

### 国際化対応
- flutter_localizations 統合
- 日本語ロケール設定
- 適切なフォント選択

## 今後の拡張ポイント

### 技術的改善
- 状態管理ライブラリ（Riverpod等）検討
- CI/CDパイプライン
- パフォーマンス監視強化

### 機能拡張
- 音声入力対応
- 高度なデータ分析
- 外部ストレージ連携（オプション）
- マルチプラットフォーム最適化

この設計により、プライバシーを保護しながら高品質なユーザーエクスペリエンスを提供し、将来の機能拡張にも対応可能な堅牢なアーキテクチャを実現している。