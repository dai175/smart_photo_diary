# Smart Photo Diary アーキテクチャ設計

## アーキテクチャ概要

Smart Photo Diaryは、写真を選ぶだけでAIが自動的に日記を生成するモバイルアプリです。フリーミアムモデルとプライバシーファースト設計により、ユーザーにとって価値のある体験を提供しながら、すべてのデータを端末ローカルに安全に保存します。

## 全体アーキテクチャ

### サービス層パターン
アプリは以下のサービス層で構成され、依存性注入による疎結合設計を採用：

#### コアサービス
- **DiaryService**: 中央データ管理、Hiveデータベース操作、depends on AiService
- **PhotoService**: 写真アクセスと権限管理（photo_manager）、PhotoServiceInterface実装
- **AiService**: AI日記生成（Google Gemini API + オフラインフォールバック）、depends on SubscriptionService
- **SettingsService**: アプリ設定管理（SharedPreferences）、Result<T>パターン採用

#### 専門サービス
- **SubscriptionService**: In-App Purchase統合とプラン管理、ISubscriptionService実装
- **PromptService**: ライティングプロンプト管理と分析、IPromptService実装、depends on LoggingService
- **StorageService**: ファイルシステム操作、データエクスポート機能
- **LoggingService**: 構造化ログとパフォーマンス監視
- **ImageClassifierService**: オンデバイスML推論（将来拡張用）

### エラーハンドリングアーキテクチャ

#### Result<T>パターン
関数型エラーハンドリングによる型安全性の確保：
- **Result<T>**: 成功（Success<T>）と失敗（Failure<T>）の明示的表現
- **関数操作**: map、fold、chain、onSuccess、onFailureによる流暢なAPI
- **ヘルパーユーティリティ**: ResultHelper、ErrorHandler
- **UI統合**: Result<T>からUI表示への直接変換

#### 統一例外階層
- **AppException**: 基底例外クラス（メッセージ、詳細、元エラー）
- **ドメイン固有例外**: ServiceException、PhotoAccessException、AiProcessingException
- **ErrorHandler**: エラー変換、ログ出力、安全実行のユーティリティ

#### 統一エラー表示システム
- **ErrorDisplayService**: 重要度別エラー表示の中央管理
- **4段階重要度**: Info、Warning、Error、Critical
- **表示方式**: SnackBar、Dialog、Inline、FullScreen
- **自動ログ**: すべてのエラーを自動的にLoggingServiceに記録

### 依存性注入システム
- **ServiceLocator**: 中央DIコンテナ（シングルトン、ファクトリー、非同期ファクトリー対応）
- **インターフェース設計**: テスタビリティとモック化の向上
- **遅延初期化**: パフォーマンス最適化とメモリ効率
- **サービス依存関係**: 明確な依存グラフと循環依存回避

## データフローアーキテクチャ

### 日記生成フロー
```
1. ユーザー写真選択（PhotoService）
   ↓
2. 写真データ準備・プロンプト選択（UI Layer）
   ↓
3. AI推論リクエスト（AiService）
   ├─ オンライン: Google Gemini API
   └─ オフライン: テンプレートベース生成
   ↓
4. 生成結果の処理・検証
   ↓
5. ローカルDB保存（DiaryService）
   ↓
6. UI更新・統計情報更新
```

### ライティングプロンプトフロー
```
1. プロンプト一覧表示（PromptService）
   ├─ 基本ユーザー: 5プロンプト
   └─ Premiumユーザー: 全20プロンプト
   ↓
2. プロンプト選択・使用記録
   ↓
3. 分析データ蓄積（4層分析システム）
   ├─ 使用頻度分析
   ├─ カテゴリ人気度分析
   ├─ ユーザー行動分析
   └─ 改善提案システム
```

### 収益化フロー
```
1. 機能利用試行（AiService、PromptService）
   ↓
2. 使用量チェック（SubscriptionService）
   ├─ 制限内: 機能実行
   └─ 制限超過: アップグレード提案
   ↓
3. In-App Purchase実行
   ↓
4. プラン変更・機能解放
```

## AI処理アーキテクチャ

### Google Gemini API統合
- **AiService**: Google Gemini 2.5 Flash APIの統合管理
- **GeminiApiClient**: 直接API通信とレスポンス処理
- **DiaryGenerator**: 日記生成の中核ロジック
- **TagGenerator**: 自動タグ生成機能

### オフライン対応
- **OfflineFallbackService**: ネットワーク切断時の代替処理
- **テンプレートベース生成**: パターンマッチングによる基本的な日記生成
- **接続状態監視**: connectivity_plusによるリアルタイム状態管理

### 環境設定管理
- **EnvironmentConfig**: APIキーの安全な管理とキャッシュ
- **環境変数検証**: 起動時のAPIキー有効性確認
- **デバッグ対応**: 開発環境での強制プラン変更機能

## データ永続化アーキテクチャ

### Hive NoSQLデータベース
```dart
// 主要データモデル
- DiaryEntry: 日記エントリー（自動生成アダプター）
- WritingPrompt: ライティングプロンプト（自動生成アダプター）
- SubscriptionStatus: サブスクリプション状態
- アプリ設定: テーマ、言語、生成モード
- 統計データ: 使用量分析、行動パターン
```

### ファイルシステム管理
- **photo_manager**: 写真ファイルへの参照管理
- **file_picker**: ユーザー選択可能なエクスポート先
- **データエクスポート**: JSON形式での完全データ出力
- **データベース最適化**: Hive圧縮とストレージクリーンアップ

### データベース設計原則
- **ローカルファースト**: すべてのデータは端末内保存
- **プライバシー保護**: 外部送信なし、クラウド同期なし
- **パフォーマンス**: 効率的なインデックス設計
- **整合性**: トランザクション管理とデータ検証

## UI/UX アーキテクチャ

### デザインシステム
- **Material Design 3**: 統一されたデザイン言語とコンポーネント
- **テーマシステム**: ライト/ダーク/システム連動テーマ
- **動的カラー**: Theme.of(context).colorSchemeによる適応的色彩
- **日本語タイポグラフィ**: Google Fontsとロケール最適化

### 画面構成・ナビゲーション
- **ホーム画面**: 写真選択とクイックアクセス、最近の日記表示
- **日記一覧**: フィルター・検索機能、カード表示
- **統計画面**: カレンダー表示と分析データ可視化
- **設定画面**: テーマ・データ管理・サブスクリプション
- **ライティングプロンプト画面**: カテゴリ別プロンプト表示・検索

### 状態管理パターン
- **コントローラーパターン**: ChangeNotifierによるリアクティブ状態管理
- **PhotoSelectionController**: 写真選択状態とバリデーション
- **DiaryScreenController**: 日記画面の複雑な状態管理
- **ローカル状態**: StatefulWidgetによる単純な状態管理

### UIコンポーネント設計
- **CustomDialog**: 統一されたダイアログデザイン
- **AnimatedButton**: マイクロインタラクション対応ボタン
- **ModernChip**: Material Design 3準拠のチップコンポーネント
- **ErrorDisplayWidgets**: 重要度別エラー表示コンポーネント

## 収益化アーキテクチャ

### フリーミアムモデル実装
```dart
// プラン定義
enum SubscriptionPlan {
  basic,           // 無料: 10回/月、5プロンプト
  premiumMonthly,  // ¥300/月: 100回/月、20プロンプト
  premiumYearly,   // ¥2,800/年: 100回/月、20プロンプト
}
```

### In-App Purchase統合
- **SubscriptionService**: 完全なサブスクリプション管理
- **InAppPurchaseConfig**: ストア商品IDとプラン設定の管理
- **使用量追跡**: 月次カウンターと自動リセット機能
- **プラン執行**: 機能アクセス制御とアップグレード誘導

### 分析システム（4層アーキテクチャ）
1. **使用頻度分析**: プロンプト人気度とダイバーシティインデックス
2. **カテゴリ分析**: トレンド分析と前期比較
3. **行動分析**: 時間パターンとエンゲージメント測定
4. **改善提案**: 効果測定とフィードバック収集

## セキュリティ・プライバシーアーキテクチャ

### データローカライゼーション
- **完全ローカル保存**: 全ユーザーデータは端末内のみ
- **API通信最小化**: 日記生成時のみGoogle Gemini APIに接続
- **データ暗号化**: Hiveによるローカルデータベース暗号化
- **権限最小化**: 写真アクセスのみ、他の権限要求なし

### セキュリティ設計原則
- **ゼロトラスト**: 外部サービスへの最小限信頼
- **透明性**: オープンソースによる実装の透明性
- **ユーザー制御**: データエクスポート・削除の完全制御
- **プライバシーバイデザイン**: 設計段階からのプライバシー保護

## パフォーマンス最適化アーキテクチャ

### 画像処理最適化
- **RepaintBoundary**: 適切な描画境界設定
- **効率的キャッシュ**: 画像メモリ管理とライフサイクル
- **デバイス対応**: ピクセル比とスクリーンサイズ適応

### メモリ・CPU最適化
- **遅延初期化**: サービスの必要時読み込み
- **効率的なデータ構造**: Hiveによる高速NoSQL操作
- **バックグラウンド処理**: AI生成の非同期実行
- **ガベージコレクション**: 適切なリソース解放

## テストアーキテクチャ

### 3層テスト戦略
```
Unit Tests (test/unit/)
├─ services/: サービス層ロジック
├─ models/: データモデル検証
├─ core/: Result<T>パターン・DI
├─ analytics/: 分析システム（58テスト）
└─ utils/: ユーティリティ機能

Widget Tests (test/widget/)
├─ UI コンポーネント単体
├─ 状態管理検証
└─ ユーザーインタラクション

Integration Tests (test/integration/)
├─ E2E フロー検証
├─ サービス統合テスト
└─ 実環境シミュレーション
```

### テスト支援アーキテクチャ
- **mocktail**: 統一されたモック化フレームワーク
- **MockPlatformChannels**: プラットフォーム機能のモック
- **依存性注入**: テスト用サービス差し替え
- **テストヘルパー**: WidgetTestHelpers、IntegrationTestHelpers

### 品質保証システム
- **100%テスト成功率**: 600+テストの継続的成功
- **静的解析**: Flutter analyze 0 issues維持
- **カバレッジ監視**: コードカバレッジ測定と改善
- **CI/CD統合**: GitHub Actionsによる自動品質チェック

## 開発品質アーキテクチャ

### コード品質管理
- **Flutter Lints**: カスタムリント設定
- **一貫性**: 命名規則とコーディングスタンダード
- **型安全性**: Dartの厳密型システム活用
- **関数型要素**: Result<T>パターンによる堅牢性

### 国際化・ローカライゼーション
- **flutter_localizations**: 日本語ロケール統合
- **フォント最適化**: 中華フォント回避設定
- **日本語優先**: UIテキストとコメントの日本語化
- **文化的配慮**: 日本のユーザー体験に最適化

### 開発者体験
- **CLAUDE.md**: 包括的開発ガイドライン
- **コード生成**: build_runnerによる自動化
- **デバッグツール**: 構造化ログとエラー追跡
- **ホットリロード**: 高速開発サイクル

## 拡張性・将来性

### アーキテクチャ拡張ポイント
- **マルチプラットフォーム**: Web・デスクトップ対応準備済み
- **プラグインアーキテクチャ**: 新機能の疎結合統合
- **API抽象化**: AI提供者の変更・追加対応
- **ストレージ抽象化**: 他のデータベースエンジン対応

### 技術負債管理
- **定期的リファクタリング**: アーキテクチャの継続的改善
- **依存関係管理**: 外部ライブラリの計画的更新
- **パフォーマンス監視**: 継続的な最適化
- **セキュリティ更新**: 定期的な脆弱性対応

## 運用・監視アーキテクチャ

### ログ・監視システム
- **LoggingService**: 構造化ログ出力
- **パフォーマンス監視**: 応答時間とリソース使用量
- **エラー追跡**: 包括的エラーログとスタックトレース
- **使用状況分析**: 匿名化された機能利用統計

### CI/CDアーキテクチャ
- **GitHub Actions**: 自動ビルド・テスト・デプロイ
- **品質ゲート**: テスト・静的解析・カバレッジチェック
- **段階的デプロイ**: 内部→α→β→本番の安全なリリース
- **自動化**: リリースノート生成とアーティファクト配布

この包括的なアーキテクチャにより、Smart Photo Diaryは高品質・高性能・高セキュリティを実現しながら、将来の機能拡張とスケールアップに対応可能な堅牢な基盤を提供しています。