# 過去の写真機能 実装チェックリスト

## 1. バックエンド実装 (Model & Service層)

### 1.1 PhotoService拡張
- [x] `getPhotosForDate()` メソッドの実装
  - [x] 指定日付の写真を取得するロジック
  - [x] photo_managerプラグインのフィルター機能調査
  - [x] 撮影日時によるフィルタリング実装
  - [x] タイムゾーン考慮の実装
- [ ] `getAccessibleDateRange()` メソッドの実装
  - [ ] Planクラスに基づいた期間計算
  - [ ] BasicPlan: 1日前まで
  - [ ] PremiumPlan: 365日前まで
- [ ] `isPhotoAccessible()` メソッドの実装
  - [ ] 写真の撮影日時とプランに基づくアクセス可否判定
- [x] ページネーション対応
  - [x] `getPhotosForDateRange()` with offset/limit
  - [x] 効率的なメモリ管理

### 1.2 DiaryService拡張
- [x] `createDiaryForPastPhoto()` メソッドの追加
  - [x] 過去の日付での日記作成ロジック
  - [x] 既存の日記との重複チェック
  - [x] 作成日時と写真撮影日時の管理
- [x] `getDiaryByPhotoDate()` メソッドの追加
  - [x] 写真の撮影日付で日記を検索

### 1.3 AiService拡張
- [ ] プロンプト生成の調整
  - [ ] 過去の日付情報をプロンプトに含める
  - [ ] 「思い出を振り返る」文脈の追加
  - [ ] 時制の適切な調整（過去形での生成）

### 1.4 新しいモデルクラス
- [ ] `DateRange` クラスの作成
  - [ ] start/endのDateTime管理
  - [ ] 期間内判定メソッド
- [ ] `PhotoAccessibility` enumの作成
  - [ ] accessible / locked / limited

## 2. UI実装 (Presentation層)

### 2.1 写真選択画面の改修
- [x] タブ実装
  - [x] 「今日」タブ（既存）
  - [x] 「過去の写真」タブ（新規）
  - [x] タブ切り替えアニメーション
- [x] 過去の写真表示UI（基本実装完了）
  - [x] 月別グループ表示の実装（PastPhotoGridWidget）
  - [x] 日付ヘッダーの表示
  - [ ] スクロール性能の最適化

### 2.2 写真グリッド表示の拡張
- [x] アクセス制限表示
  - [x] ロックアイコンのオーバーレイ
  - [x] グレーアウト効果の実装
  - [x] 「プレミアム限定」バッジ
- [x] 写真選択時の処理
  - [x] アクセス可能な写真: 通常の選択フロー
  - [x] **プロンプト選択モーダルの実装（過去の写真タブ）**
  - [x] **今日の写真と過去の写真でのUX統一**
  - [x] 制限された写真: アップグレード促進ダイアログ

### 2.3 カレンダーUI（Phase 2）
- [ ] カレンダーウィジェットの実装
  - [ ] 月表示カレンダー
  - [ ] 写真のある日付にインジケーター
  - [ ] 日付選択で該当写真へスクロール
- [ ] 月単位のナビゲーション
  - [ ] 前月/次月への移動
  - [ ] アクセス可能期間の視覚的表示

### 2.4 アップグレード促進UI
- [ ] 制限通知ダイアログ
  - [ ] CustomDialogベースで実装
  - [ ] プレミアムプランの価値訴求
  - [ ] 「プレミアムを見る」ボタン
- [ ] インライン促進表示
  - [ ] 制限エリアでの説明テキスト
  - [ ] スムーズなアップグレードフロー

## 3. 状態管理とビジネスロジック

### 3.1 Provider/State管理
- [ ] `PastPhotosState` の作成
  - [ ] 選択中の日付
  - [ ] 読み込み中の写真リスト
  - [ ] ページネーション状態
- [ ] `PhotoSelectionNotifier` の拡張
  - [ ] 日付別の写真管理
  - [ ] アクセス制限状態の管理

### 3.2 権限とアクセス制御
- [ ] プラン別アクセス制御の実装
  - [ ] SubscriptionServiceとの連携
  - [ ] リアルタイムのプラン状態確認
- [ ] エラーハンドリング
  - [ ] アクセス拒否時の処理
  - [ ] Result<T>パターンの活用

## 4. テスト実装

### 4.1 Unit Tests
- [ ] PhotoService拡張機能のテスト
  - [ ] 日付フィルタリングテスト
  - [ ] アクセス制限判定テスト
  - [ ] ページネーションテスト
- [ ] DiaryService拡張機能のテスト
  - [ ] 過去日付での作成テスト
  - [ ] 重複チェックテスト
- [ ] プラン別制限ロジックのテスト
  - [ ] BasicPlan: 1日制限
  - [ ] PremiumPlan: 365日制限

### 4.2 Widget Tests
- [ ] タブ切り替えUIテスト
- [ ] 写真グリッド表示テスト
  - [ ] ロック表示の確認
  - [ ] タップ時の動作確認
- [ ] アップグレード促進UIテスト

### 4.3 Integration Tests
- [ ] エンドツーエンドフロー
  - [ ] 過去の写真選択→日記作成
  - [ ] 制限写真タップ→アップグレード
  - [ ] プラン変更後のアクセス確認

## 5. パフォーマンス最適化

### 5.1 写真読み込み最適化
- [ ] サムネイル生成とキャッシング
  - [ ] 適切なサムネイルサイズの決定
  - [ ] メモリキャッシュの実装
  - [ ] ディスクキャッシュの検討
- [ ] 遅延読み込みの実装
  - [ ] 画面に表示される写真のみロード
  - [ ] スクロール時の先読み

### 5.2 メモリ管理
- [ ] 大量写真表示時のメモリ使用量監視
- [ ] 不要な写真データの解放
- [ ] メモリリーク対策

## 6. エラーハンドリングとエッジケース

### 6.1 エラー処理
- [ ] 写真読み込みエラー
- [ ] 権限エラー
- [ ] ネットワークエラー（AI生成時）
- [ ] ストレージ不足エラー

### 6.2 エッジケース対応
- [ ] EXIF情報のない写真
- [ ] 破損した写真ファイル
- [ ] 日付が未来の写真
- [ ] タイムゾーン変更時の挙動

## 7. ドキュメントとコード品質

### 7.1 コードドキュメント
- [ ] 新規メソッドのドキュメント記述
- [ ] 複雑なロジックへのコメント追加
- [ ] APIドキュメントの更新

### 7.2 コード品質
- [ ] `fvm flutter analyze` でのエラーゼロ確認
- [ ] `fvm dart format .` でのフォーマット
- [ ] 不要なprint文の削除
- [ ] TODOコメントの解決

## 8. リリース準備

### 8.1 動作確認
- [ ] iOS実機での動作確認
- [ ] 各種iOSバージョンでのテスト
- [ ] 写真ライブラリサイズ別のテスト
  - [ ] 少量（〜100枚）
  - [ ] 中量（〜1000枚）
  - [ ] 大量（10000枚以上）

### 8.2 アップデート対応
- [ ] 既存ユーザーへの影響確認
- [ ] データマイグレーション不要の確認
- [ ] アプリ更新後の初回起動テスト

### 8.3 メトリクス実装
- [ ] 機能利用率の計測
- [ ] パフォーマンスメトリクス
- [ ] エラー率の監視

## 実装順序の推奨

1. **Phase 1: 基本機能（1-2週間）**
   - PhotoService拡張（1.1）
   - 基本的なUI実装（2.1, 2.2の一部）
   - 最小限のテスト（4.1の一部）

2. **Phase 2: 完全実装（1-2週間）**
   - DiaryService/AiService拡張（1.2, 1.3）
   - 完全なUI実装（2.2完成, 2.4）
   - 状態管理（3.1, 3.2）
   - テスト完備（4.1-4.3）

3. **Phase 3: 改善と最適化（1週間）**
   - パフォーマンス最適化（5.1, 5.2）
   - エラーハンドリング強化（6.1, 6.2）
   - カレンダーUI（2.3）
   - リリース準備（8.1-8.3）