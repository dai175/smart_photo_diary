# 過去の写真機能 実装チェックリスト

## 1. バックエンド実装 (Model & Service層)

### 1.1 PhotoService拡張
- [x] `getPhotosForDate()` メソッドの実装
  - [x] 指定日付の写真を取得するロジック
  - [x] photo_managerプラグインのフィルター機能調査
  - [x] 撮影日時によるフィルタリング実装
  - [x] タイムゾーン考慮の実装
- [x] `getAccessibleDateRange()` メソッドの実装
  - [x] Planクラスに基づいた期間計算
  - [x] BasicPlan: 1日前まで
  - [x] PremiumPlan: 365日前まで
- [x] `isPhotoAccessible()` メソッドの実装
  - [x] 写真の撮影日時とプランに基づくアクセス可否判定
- [x] **PhotoAccessControlService分離設計**
  - [x] **責任の単一化（PhotoServiceから分離）**
  - [x] **依存性注入なしの純粋関数設計**
- [x] **PhotoAccessControlServiceのUI統合**
  - [x] **ServiceRegistrationへの登録**
  - [x] **PastPhotosSelectionScreenでの統合**
  - [x] **プラン別アクセス範囲の視覚的表示**
- [x] ページネーション対応
  - [x] `getPhotosForDateRange()` with offset/limit
  - [x] 効率的なメモリ管理

### 1.2 DiaryService拡張
- [x] `createDiaryForPastPhoto()` メソッドの追加
  - [x] 過去の日付での日記作成ロジック
  - [x] 既存の日記との重複チェック
  - [x] 作成日時と写真撮影日時の管理
- [x] `getDiaryByPhotoDate()` メソッドの追加
  - [x] 写真の撮影日付で日記を検索

### 1.3 AiService拡張
- [x] ~~プロンプト生成の調整~~　（※設計方針により不要）
  - [x] ~~過去の日付情報をプロンプトに含める~~
  - [x] ~~「思い出を振り返る」文脈の追加~~
  - [x] ~~時制の適切な調整（過去形での生成）~~
- **設計方針**: 過去の写真も現在の日記として作成するシンプルなアプローチを採用

### 1.4 新しいサービスクラス
- [x] **`PhotoAccessControlService` の作成**
  - [x] **プラン別アクセス制御の専用サービス**
  - [x] **純粋関数による設計（副作用なし）**
  - [x] **PhotoAccessControlServiceInterface の定義**
- [ ] ~~`DateRange` クラスの作成~~　（※設計変更により不要）
  - [ ] ~~start/endのDateTime管理~~
  - [ ] ~~期間内判定メソッド~~
- [ ] ~~`PhotoAccessibility` enumの作成~~　（※設計変更により不要）
  - [ ] ~~accessible / locked / limited~~

## 2. UI実装 (Presentation層)

### 2.1 写真選択画面の改修
- [x] タブ実装
  - [x] 「今日」タブ（既存）
  - [x] 「過去の写真」タブ（新規）
  - [x] タブ切り替えアニメーション
- [x] 過去の写真表示UI（基本実装完了）
  - [x] 月別グループ表示の実装（PastPhotoGridWidget）
  - [x] 日付ヘッダーの表示
  - [x] スクロール性能の最適化

### 2.2 写真グリッド表示の拡張
- [x] アクセス制限表示
  - [x] ロックアイコンのオーバーレイ
  - [x] グレーアウト効果の実装
  - [x] 「プレミアム限定」バッジ
- [x] 写真選択時の処理
  - [x] アクセス可能な写真: 通常の選択フロー
  - [x] **プロンプト選択モーダルの実装（過去の写真タブ）**
  - [x] **今日の写真と過去の写真でのUX統一**
  - [x] 制限された写真: アップグレード促進ダイアログ

### 2.3 カレンダーUI（Phase 2）
- [x] カレンダーウィジェットの実装
  - [x] 月表示カレンダー
  - [x] 写真のある日付にインジケーター
  - [x] 日付選択で該当写真へスクロール
- [x] 月単位のナビゲーション
  - [x] 前月/次月への移動
  - [x] アクセス可能期間の視覚的表示

### 2.4 アップグレード促進UI
- [x] 制限通知ダイアログ
  - [x] CustomDialogベースで実装
  - [x] プレミアムプランの価値訴求
  - [x] 「プレミアムを見る」ボタン
- [x] インライン促進表示
  - [x] 制限エリアでの説明テキスト
  - [x] スムーズなアップグレードフロー

## 3. 状態管理とビジネスロジック

### 3.1 Provider/State管理
- [x] `PastPhotosState` の作成
  - [x] 選択中の日付
  - [x] 読み込み中の写真リスト
  - [x] ページネーション状態
- [x] `PhotoSelectionNotifier` の拡張
  - [x] 日付別の写真管理
  - [x] アクセス制限状態の管理

### 3.2 権限とアクセス制御
- [x] プラン別アクセス制御の実装
  - [x] SubscriptionServiceとの連携
  - [x] リアルタイムのプラン状態確認
- [x] エラーハンドリング
  - [x] アクセス拒否時の処理
  - [x] Result<T>パターンの活用

## 4. テスト実装

### 4.1 Unit Tests
- [x] PhotoService拡張機能のテスト
  - [x] 日付フィルタリングテスト（モックテストのみ）
  - [ ] アクセス制限判定テスト（※PhotoAccessControlServiceに移行）
  - [x] ページネーションテスト（モックテストのみ）
  - [ ] **実装テストの強化が必要**（エラーハンドリング、実際のフィルタリングロジック）
- [ ] **DiaryService拡張機能のテスト（未実装）**
  - [ ] **createDiaryForPastPhoto()のテスト作成**
  - [ ] **getDiaryByPhotoDate()のテスト作成**
  - [ ] **過去日付での作成ロジックテスト**
  - [ ] **重複チェックロジックテスト**
- [x] **PhotoAccessControlService専用テスト**
  - [x] **プラン別制限ロジックのテスト**
    - [x] **BasicPlan: 1日制限**
    - [x] **PremiumPlan: 365日制限**
  - [x] **境界値テスト（日付精度、うるう年、DST）**
  - [x] **エッジケース処理テスト**

### 4.2 Widget Tests
- [x] タブ切り替えUIテスト
- [x] 写真グリッド表示テスト
  - [x] ロック表示の確認
  - [x] タップ時の動作確認
- [x] アップグレード促進UIテスト

### 4.3 Integration Tests
- [x] エンドツーエンドフロー
  - [x] 過去の写真選択→日記作成
  - [x] 制限写真タップ→アップグレード
  - [x] プラン変更後のアクセス確認

## 5. パフォーマンス最適化

### 5.1 写真読み込み最適化
- [x] サムネイル生成とキャッシング
  - [x] 適切なサムネイルサイズの決定
  - [x] メモリキャッシュの実装
  - [x] ディスクキャッシュの検討（メモリキャッシュで十分と判断）
- [x] 遅延読み込みの実装
  - [x] 画面に表示される写真のみロード
  - [x] スクロール時の先読み

### 5.2 メモリ管理
- [x] 大量写真表示時のメモリ使用量監視
- [x] 不要な写真データの解放
- [x] メモリリーク対策

## 6. エラーハンドリングとエッジケース

### 6.1 エラー処理
- [x] 写真読み込みエラー
- [x] 権限エラー
- [x] ネットワークエラー（AI生成時）
- [x] ストレージ不足エラー

### 6.2 エッジケース対応
- [x] EXIF情報のない写真
- [x] 破損した写真ファイル
- [x] 日付が未来の写真
- [x] タイムゾーン変更時の挙動

## 7. ドキュメントとコード品質

### 7.1 コードドキュメント
- [ ] **新規メソッドのドキュメント記述**
  - [ ] createDiaryForPastPhoto()のドキュメント
  - [ ] getDiaryByPhotoDate()のドキュメント
  - [ ] getPhotosForDate()の詳細コメント
- [ ] **複雑なロジックへのコメント追加**
  - [ ] 日付フィルタリングロジック
  - [ ] 重複チェックロジック
- [ ] **APIドキュメントの更新**

### 7.2 コード品質
- [x] `fvm flutter analyze` でのエラーゼロ確認
- [x] `fvm dart format .` でのフォーマット
- [x] 不要なprint文の削除
- [x] TODOコメントの解決

## 8. リリース準備

### 8.1 動作確認
- [ ] iOS実機での動作確認
- [ ] 各種iOSバージョンでのテスト
- [ ] 写真ライブラリサイズ別のテスト
  - [ ] 少量（〜100枚）
  - [ ] 中量（〜1000枚）
  - [ ] 大量（10000枚以上）

### 8.2 アップデート対応
- [ ] 既存ユーザーへの影響確認
- [ ] データマイグレーション不要の確認
- [ ] アプリ更新後の初回起動テスト

### 8.3 メトリクス実装
- [ ] 機能利用率の計測
- [ ] パフォーマンスメトリクス
- [ ] エラー率の監視

## 実装順序の推奨（更新版）

1. **Phase 1: 基本機能（1-2週間）** ✅ **完了**
   - PhotoService拡張（1.1） ✅
   - PhotoAccessControlService新規作成（1.4） ✅
   - DiaryService拡張（1.2） ✅
   - 基本的なUI実装（2.1, 2.2の一部） ✅
   - 最小限のテスト（4.1の一部） ✅

2. **Phase 2: 完全実装（1-2週間）**
   - ~~AiService拡張（1.3）~~ ※設計方針により不要
   - 完全なUI実装（2.2完成, 2.4） ✅ **完了**
   - 状態管理（3.1, 3.2） ✅ **完了**
   - テスト完備（4.1-4.3） ⚠️ **DiaryServiceテスト未完了**

3. **Phase 3: 改善と最適化（1週間）**
   - パフォーマンス最適化（5.1, 5.2）
   - エラーハンドリング強化（6.1, 6.2）
   - カレンダーUI（2.3） ✅ **完了**
   - **テスト完備（4.1: DiaryService）** ⚠️ **最優先**
   - **コードドキュメント整備（7.1）** 📋 **必要**
   - リリース準備（8.1-8.3）

## アーキテクチャ改善記録

### 設計変更の履歴
- **2025-07-29**: PhotoServiceから責任分離によりPhotoAccessControlService新規作成
- **変更理由**: 単一責任の原則、テスタビリティ向上、依存関係の削減
- **影響範囲**: UI層でのプラン取得とアクセス制御の組み合わせが必要

- **2025-07-30**: AiService拡張を設計方針により不要と判断
- **変更理由**: 過去の写真も現在の日記として作成するシンプルなアプローチを採用
- **影響範囲**: 振り返り風の文脈調整なし、既存のAI生成ロジックをそのまま活用

- **2025-07-30**: カレンダーUIを実装
- **実装内容**: TableCalendarを使用したカレンダービュー、写真・日記の存在表示、アクセス制限の視覚化
- **追加機能**: グリッド/カレンダーの切り替え、凡例表示、focusedDayエラー修正