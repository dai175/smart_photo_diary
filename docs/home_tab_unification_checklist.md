# ホーム画面タブ統一実装チェックリスト

## Phase 1: 基盤準備 (1-2日)

### 📋 分析・設計
- [x] 既存コードの詳細分析完了
  - [x] `home_screen.dart` の TabController 使用箇所の特定
  - [x] `home_content_widget.dart` のタブ関連ロジック特定
  - [x] `PhotoSelectionController` の使用状況確認
- [x] 新しいタイムライン用データ構造設計
  - [x] 日付グルーピング仕様の詳細化
  - [x] 写真取得ロジックの統一仕様作成
- [x] FAB統合仕様の詳細設計完了

### 🧪 テスト環境準備
- [x] 既存テストケースの実行・確認
  - [x] `fvm flutter test` の成功確認
  - [x] カバレッジレポートの取得
- [x] 変更対象ファイルのテスト追加検討
- [x] テスト用のモックデータ準備

## Phase 2: 基本統合実装 (2-3日)

### 🏗️ コアロジック実装
- [x] タイムライン用の新しいウィジェット作成
  - [x] `TimelinePhotoWidget` の基本実装
  - [x] `CustomScrollView` + `Sliver` ベース構造
  - [x] 日付ヘッダー (`SliverPersistentHeader`) の実装
- [x] 写真グルーピングロジック実装
  - [x] `TimelineGroupingService` 作成
  - [x] 今日/昨日/月単位のグルーピング機能
  - [x] `getTimelineHeader()` メソッド実装
- [x] 統一写真取得サービス
  - [x] `UnifiedPhotoService` 作成（必要に応じて）
  - [x] 既存の写真取得ロジックの活用

### 🎨 UI実装
- [x] 日付ヘッダーコンポーネント
  - [x] スティッキーヘッダーの実装
  - [x] シンプルなテキスト表示（矢印なし）
  - [x] Material Design 3 準拠のスタイリング
- [x] 写真グリッドの統合
  - [x] 既存 `OptimizedPhotoGridWidget` の活用
  - [x] 遅延読み込み機能の維持
  - [x] キャッシュ機能の継承
  - [x] 日付制限時の視覚的フィードバック実装
    - [x] 選択可能写真の通常表示維持
    - [x] 選択不可写真の薄い表示（opacity: 0.3）
    - [x] 選択状態変更時のアニメーション

## Phase 3: FAB統合 (1-2日)

### ⚡ FAB機能統合
- [x] スマートFAB実装
  - [x] 選択状態に応じたアイコン切り替え
  - [x] アニメーション実装 (`AnimatedSwitcher`)
  - [x] 色とアイコンの動的変更
- [x] FABアクション統合
  - [x] カメラ撮影処理の移植
  - [x] 日記作成処理の移植
  - [x] エラーハンドリングの実装
- [x] tooltip実装
  - [x] 選択枚数の動的表示
  - [x] アクセシビリティ対応

### 📱 レスポンシブ対応
- [x] 画面サイズ対応の確認
- [x] SafeArea の適切な処理
- [x] FABの位置調整

## Phase 4: 既存機能削除 (1日)

### 🗑️ 不要コード削除
- [x] タブ関連の削除
  - [x] `TabController` の削除（Phase 5で完了済み）
  - [x] `_tabController` 関連メソッドの削除（Phase 5で完了済み）
  - [x] タブ切り替えロジックの削除（Phase 5で完了済み）
- [x] 最近の日記セクション削除
  - [x] `_buildRecentDiariesSection` の削除
  - [x] `RecentDiariesWidget` 関連処理の削除
  - [x] 関連する状態管理の削除
- [x] 過去タブ特有機能の削除
  - [x] カレンダー表示関連コードの削除（該当機能なし）
  - [x] プラン制限表示ロジックの削除（該当機能なし）
  - [x] `PastPhotoCalendarWidget` の削除（該当機能なし）

### 🧹 リファクタリング
- [x] 不要なインポートの削除
- [x] 使用されていない変数・メソッドの削除
- [x] コメントの更新
- [x] ファイル名の見直し（不要と判断）

## Phase 5: 統合・テスト (2-3日)

### 🔗 統合実装
- [x] `home_screen.dart` の更新
  - [x] 新しいタイムラインウィジェットの統合
  - [x] 既存のナビゲーション処理の維持
  - [x] 権限処理の統合
- [x] `home_content_widget.dart` の大幅リファクタリング
  - [x] タブ構造の完全削除
  - [x] 新しいタイムライン表示への置き換え
  - [x] プル・トゥ・リフレッシュの維持

### 🧪 包括的テスト
- [ ] 単体テスト
  - [ ] 新しいタイムライン関連のテスト作成
  - [ ] FABアクションのテスト
  - [ ] 日付グルーピングロジックのテスト
- [ ] ウィジェットテスト
  - [ ] UI表示の確認
  - [ ] インタラクションのテスト
  - [ ] アニメーションのテスト
  - [ ] 日付制限フィードバックのテスト
    - [ ] 選択時の薄い表示切り替え
    - [ ] 選択解除時の表示復帰
- [ ] 統合テスト
  - [ ] エンドツーエンドの動作確認
  - [ ] 権限関連の動作確認
  - [ ] エラーケースのテスト

## Phase 6: スティッキーヘッダー実装 (2-3日)

### 🏷️ スティッキーヘッダー機能実装
- [x] 基盤構造の変更 (Phase 6.1)
  - [x] `ListView.builder` → `CustomScrollView` への変換
  - [x] `ScrollController` の追加とスクロール監視実装
  - [x] 既存機能の動作確認（写真選択、表示等）
- [x] スクロール位置監視システム構築 (Phase 6.2)
  - [x] グループ境界計算ロジック実装
  - [x] 可視グループ特定アルゴリズム実装
  - [x] スクロール位置からグループインデックス特定機能
- [ ] スティッキーヘッダー実装 (Phase 6.3)
  - [ ] `_StickyDateHeaderDelegate` クラス作成
  - [ ] `SliverPersistentHeader(pinned: true)` 実装
  - [ ] 動的ヘッダーコンテンツ切り替え機能
  - [ ] 既存ヘッダーと同一スタイルの適用

### 🎛️ 技術仕様詳細
- [ ] スティッキーヘッダー動作仕様
  - [ ] 単一固定ヘッダー（画面最上部に1つのみ）
  - [ ] スクロール位置に応じた動的コンテンツ切り替え
  - [ ] 現在画面上部の写真グループの `displayName` を表示
  - [ ] 高さ48px、既存と同一の背景色・テキストスタイル
- [ ] CustomScrollView構造設計
  - [ ] `SliverPersistentHeader` + `SliverList.builder` 構成
  - [ ] 通常ヘッダーとスティッキーヘッダーの共存
  - [ ] 既存のグリッド表示機能の完全保持

### 🔧 パフォーマンス最適化
- [ ] スクロール計算最適化
  - [ ] グリッド高さ計算式の標準化
  - [ ] スクロールイベントのデバウンス処理
  - [ ] 計算結果のキャッシュ実装
- [ ] メモリ管理
  - [ ] 大量写真でのスクロール性能確認
  - [ ] リビルド頻度の最適化
  - [ ] 不要な再計算の防止

### 🧪 スティッキーヘッダーテスト
- [ ] 機能テスト
  - [ ] スクロール時のヘッダー内容変更確認
  - [ ] 各グループ（今日、昨日、月単位）での表示確認
  - [ ] エッジケース（空グループ、単一グループ）対応
- [ ] 既存機能への影響確認
  - [ ] 写真選択機能の動作確認
  - [ ] 薄化表示機能の動作確認
  - [ ] 使用済みラベル機能の動作確認
  - [ ] FAB統合機能の動作確認

## Phase 7: 品質保証・最適化 (1-2日)

### 🔍 品質チェック
- [ ] コード品質確認
  - [ ] `fvm flutter analyze` の実行・修正
  - [ ] `fvm dart format .` の実行
  - [ ] lint ルールの準拠確認
- [ ] パフォーマンステスト
  - [ ] 大量写真でのスクロール性能確認
  - [ ] メモリ使用量の測定
  - [ ] 画像読み込み性能の確認
  - [ ] スティッキーヘッダーのレスポンス性能確認
- [ ] アクセシビリティチェック
  - [ ] スクリーンリーダー対応
  - [ ] キーボードナビゲーション
  - [ ] コントラスト比の確認

### 📊 最終確認
- [ ] 各プラン（Basic/Premium）での動作確認
- [ ] 権限パターンでの動作確認
  - [ ] 写真ライブラリ権限拒否
  - [ ] Limited Access
  - [ ] Full Access
- [ ] エラー処理の確認
  - [ ] ネットワークエラー
  - [ ] 写真アクセスエラー
  - [ ] AI生成エラー

## Phase 8: リリース準備 (1日)

### 📝 ドキュメント更新
- [ ] `CLAUDE.md` の更新（該当する場合）
- [ ] コード内コメントの更新
- [ ]変更ログの作成

### 🚀 デプロイメント準備
- [ ] 最終テスト実行 (`fvm flutter test`)
- [ ] ビルド確認 (`fvm flutter build ios --release`)
- [ ] サンドボックス環境でのテスト
- [ ] プロダクション環境への影響評価

---

## ⚠️ 重要な注意事項

### 品質管理
- **各Phaseで必ずテストを実行**し、100%成功を維持する
- **`fvm flutter analyze`** で警告・エラーゼロを維持する
- **既存機能に影響を与えない**ことを各段階で確認する

### 実装指針
- **段階的実装**: 一度に大きな変更をせず、小さなステップで進める
- **既存コード活用**: 可能な限り既存の`OptimizedPhotoGridWidget`等を再利用
- **エラーハンドリング**: 各機能で適切なエラー処理を実装

### 確認項目
- [ ] 全フェーズ完了後、既存の800+テストが100%成功
- [ ] メモリリークの発生なし
- [ ] UI/UXの一貫性維持
- [ ] アクセシビリティガイドライン準拠

---

## 📋 進捗管理

各チェックボックスは実装完了時にチェックし、問題が発生した場合は詳細を記録してください。

**開始日**: 2025年1月15日  
**Phase 6 開始日**: 2025年9月6日  
**予定完了日**: 2025年1月25日  
**実際の完了日**: Phase 1完了 (2025年1月15日), Phase 2完了 (2025年1月15日), Phase 3完了 (2025年1月15日), Phase 4完了 (2025年1月15日), Phase 5完了 (2025年1月15日), Phase 6.1完了 (2025年9月6日), Phase 6.2完了 (2025年9月6日)

## 📋 Phase 6 実装計画詳細

### 🎯 スティッキーヘッダー実装目標
- **動的固定ヘッダー**: スクロール位置に応じて「今日」「昨日」「2025年9月」などの日付ヘッダーを画面最上部に固定表示
- **単一ヘッダー管理**: 複数ヘッダーの同時固定を避け、現在見えているグループのヘッダーのみ表示
- **既存機能保持**: 写真選択、薄化表示、使用済みラベルなどの全機能を完全維持

### 🔧 技術アプローチ
1. **ListView → CustomScrollView変換**: Sliver系ウィジェットでの高度なスクロール制御
2. **ScrollController活用**: リアルタイムスクロール位置監視
3. **SliverPersistentHeaderDelegate**: カスタムスティッキーヘッダー実装
4. **グループ境界計算**: 各写真グループの画面位置を正確に算出

### ⚠️ 実装リスク管理
- **パフォーマンス最適化**: スクロール毎の再計算負荷を最小化
- **既存機能保護**: 段階的実装により機能破綻を防止
- **計算精度確保**: 動的グリッド高さの正確な算出