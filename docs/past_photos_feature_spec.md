# 過去の写真から日記を作成する機能仕様書

## 概要

Smart Photo Diaryに「過去の写真から日記を作成する」機能を追加し、ユーザーが今日以前の写真を使って思い出の日記を作成できるようにします。この機能は、プランによって遡れる期間に制限を設けることで、プレミアムプランへのアップグレードを促進します。

## ビジネス目標

1. **ユーザーエンゲージメントの向上**: 過去の思い出を振り返る機会を提供
2. **プレミアムプランの価値向上**: より長期間の写真にアクセスできる特典を追加
3. **継続利用の促進**: 過去の日記を作成することで、アプリへの愛着を深める

## ユーザー体験設計

### 基本フロー

1. **写真選択画面の拡張**
   - 現在の「今日の写真」に加えて「過去の写真」タブを追加
   - カレンダーUIまたは月別グループ表示で過去の写真を閲覧
   - プランに応じた期間制限を視覚的に表示

2. **プラン別の制限**
   - **Basicプラン**: 昨日まで（過去1日分）
   - **Premiumプラン**: 過去1年まで（365日分）

3. **制限を超えた写真の扱い**
   - グレーアウト表示で写真は見えるが選択不可
   - タップすると「プレミアムプランで利用可能」のメッセージ表示
   - アップグレードへの導線を提供

### UI/UXの詳細設計

#### 1. 写真選択画面の改善

```
┌─────────────────────────────┐
│  写真を選択                   │
├─────────────────────────────┤
│  [今日] [過去の写真]         │ ← タブ切り替え
├─────────────────────────────┤
│  2024年7月                   │ ← 月別ヘッダー
│  ┌───┐ ┌───┐ ┌───┐       │
│  │ 29 │ │ 28 │ │ 27 │       │ ← 日付表示
│  └───┘ └───┘ └───┘       │
│  [写真] [写真] [🔒写真]      │ ← 制限された写真は🔒表示
└─────────────────────────────┘
```

#### 2. 期間制限の視覚的フィードバック

- **アクセス可能な期間**: 通常表示
- **制限された期間**: 
  - 写真にロックアイコンをオーバーレイ
  - 半透明のグレーアウト効果
  - 「プレミアム限定」のバッジ表示

#### 3. アップグレード促進UI

```
┌─────────────────────────────┐
│  もっと過去の思い出を         │
│  振り返りませんか？           │
│                             │
│  プレミアムプランなら         │
│  1年前までの写真から         │
│  日記を作成できます          │
│                             │
│  [プレミアムを見る]          │
└─────────────────────────────┘
```

## 技術実装方針

### 1. PhotoServiceの拡張

```dart
class PhotoService {
  // 既存のメソッドに日付フィルターを追加
  Future<List<AssetEntity>> getPhotosForDate(DateTime date, {
    required int offset,
    required int limit,
  }) async {
    // 指定日の写真を取得
  }

  // プランに基づいたアクセス可能期間を計算
  DateRange getAccessibleDateRange(Plan currentPlan) {
    final today = DateTime.now();
    switch (currentPlan.runtimeType) {
      case BasicPlan:
        return DateRange(
          start: today.subtract(Duration(days: 1)),
          end: today,
        );
      case PremiumMonthlyPlan:
      case PremiumYearlyPlan:
        return DateRange(
          start: today.subtract(Duration(days: 365)),
          end: today,
        );
      default:
        return DateRange(start: today, end: today);
    }
  }
}
```

### 2. UI実装の考慮事項

- **パフォーマンス**: 大量の過去写真を効率的にロード
  - ページネーション実装
  - サムネイルの遅延読み込み
  - メモリ使用量の最適化

- **日付の扱い**:
  - 写真のEXIFデータから撮影日時を取得
  - タイムゾーンの考慮
  - 日付不明の写真の扱い

### 3. 日記作成フローの調整

- 過去の日付で日記を作成する際の考慮事項:
  - 日記の作成日時 vs 写真の撮影日時
  - 既に同じ日付の日記が存在する場合の処理
  - AIプロンプトへの日付情報の追加

## セキュリティとプライバシー

1. **写真アクセス権限**
   - 既存の権限システムを活用
   - 追加の権限は不要

2. **データ保護**
   - 過去の写真も同様にローカル処理
   - AIへの送信時も既存のセキュリティポリシーを適用

## 実装優先順位

### Phase 1: 基本機能（MVP）
1. PhotoServiceに日付フィルター機能を追加
2. 過去の写真を表示する基本UI実装
3. プラン別のアクセス制限実装

### Phase 2: UX改善
1. カレンダーUIの実装
2. スムーズなスクロールとページネーション
3. アップグレード促進UIの最適化

### Phase 3: 高度な機能
1. 写真の検索・フィルター機能
2. 複数の写真から日記を作成
3. 過去の日記との重複チェック

## 成功指標

1. **エンゲージメント指標**
   - 過去の写真機能の利用率
   - 作成された過去の日記数
   - 機能利用後のリテンション率

2. **ビジネス指標**
   - Basicからプレミアムへのコンバージョン率
   - 機能リリース後のプレミアムプラン継続率

3. **技術指標**
   - 写真読み込みのパフォーマンス
   - メモリ使用量
   - クラッシュ率

## リスクと対策

1. **大量の写真によるパフォーマンス低下**
   - 対策: 効率的なページネーションとキャッシング

2. **ストレージ容量の圧迫**
   - 対策: サムネイルのみをキャッシュ、元画像は必要時にロード

3. **プラン制限への不満**
   - 対策: 明確な価値提案とスムーズなアップグレードフロー

## まとめ

この機能により、Smart Photo Diaryは単なる「今日の日記」アプリから「思い出を振り返る」アプリへと進化します。プラン別の制限により、無料ユーザーにも価値を提供しながら、プレミアムプランの魅力を高めることができます。