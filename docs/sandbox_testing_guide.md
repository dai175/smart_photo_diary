# Sandbox Testing Guide

## 概要

Smart Photo DiaryのIn-App Purchase機能をサンドボックス環境でテストするためのガイドです。

## 前提条件

### 必要なアカウント
- **Apple ID（サンドボックステスト用）**: App Store Connectで作成したテストアカウント
- **Google Playテストアカウント**: Google Play Consoleで設定したライセンステスター

### テスト環境設定
- iOS Simulator または実機（TestFlightビルド）
- Android Emulator または実機（内部テストビルド）

## iOSサンドボックステスト

### 1. テストアカウント準備
```bash
# App Store Connect → Users and Access → Sandbox Testers
- 新規テストアカウント作成
- テスト用メールアドレス設定
- 地域設定（日本）
```

### 2. デバイス設定
```bash
# iOS設定 → App Store → サンドボックスアカウント
- 本番Apple IDをサインアウト
- サンドボックステストアカウントでサインイン
```

### 3. テストシナリオ

#### 基本購入フロー
1. **Premium Monthly購入**
   - アプリ内「Premium」ボタンタップ
   - 月額プラン（¥300）選択
   - Face ID/Touch ID認証
   - 購入完了確認

2. **Premium Yearly購入**
   - 年額プラン（¥2,800）選択
   - 購入フロー実行
   - 割引率表示確認

3. **購入復元**
   - アプリ削除・再インストール
   - 「購入を復元」機能テスト
   - Premium機能アクセス確認

#### エラーケース
- **決済キャンセル**: 認証画面でキャンセル
- **ネットワークエラー**: 機内モードでの購入試行
- **重複購入**: 既存サブスクリプション中の再購入

### 4. 確認項目
- [ ] Premium機能の解放
- [ ] 使用量制限の変更（10回→100回）
- [ ] ライティングプロンプト全アクセス
- [ ] 設定画面での状態表示

## Androidサンドボックステスト

### 1. ライセンステスター設定
```bash
# Google Play Console → Setup → License testing
- テスト用Googleアカウント追加
- テストライセンス応答設定
```

### 2. テストトラック配布
```bash
# Internal testing track使用
- テストAPKアップロード
- ライセンステスターに配布
```

### 3. テストシナリオ
- iOSと同様の購入フロー
- Google Play Billing統合確認
- Android特有のバックボタン対応

## デバッグ・トラブルシューティング

### よくある問題

#### iOS
```bash
# 問題: "Cannot connect to App Store"
解決: サンドボックスアカウント設定確認

# 問題: 購入が反映されない
解決: アプリ再起動、ログ確認

# 問題: テストアカウントでサインインできない
解決: アカウント作成後24時間待機
```

#### Android
```bash
# 問題: ライセンス認証失敗
解決: テスターアカウント設定確認

# 問題: 商品が見つからない
解決: Play Consoleでの商品公開状態確認
```

### ログ確認方法
```bash
# iOS: Xcode Console
# Android: Android Studio Logcat
# アプリ内: DebugログでPurchase状態確認
```

## 本番移行前チェックリスト

### 機能確認
- [ ] 全購入フローの正常動作
- [ ] エラーハンドリングの適切性
- [ ] UI/UXの直感性
- [ ] パフォーマンスの問題なし

### セキュリティ確認
- [ ] 領収書検証の実装
- [ ] 不正購入の防止
- [ ] サーバーサイド検証（該当する場合）

### ストア準備
- [ ] App Store Connect商品設定完了
- [ ] Google Play Console設定完了
- [ ] 価格・地域設定確認
- [ ] 税務情報・契約完了

## 注意事項

### 重要な制限
- **サンドボックス購入は実際の課金なし**
- **テストアカウントは本番環境では無効**
- **定期的なテストアカウントメンテナンスが必要**

### 本番デプロイ時の変更点
- サンドボックスフラグの無効化
- 本番APIエンドポイントへの切り替え
- エラーハンドリングの最終確認

---

**更新**: 2024年12月現在  
**対象バージョン**: Smart Photo Diary v1.0以降